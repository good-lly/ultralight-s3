"use strict";var k=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var z=(o,t)=>{for(var r in t)k(o,r,{get:t[r],enumerable:!0})},D=(o,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of C(t))!U.call(o,s)&&s!==r&&k(o,s,{get:()=>t[s],enumerable:!(e=$(t,s))||e.enumerable});return o};var H=o=>D(k({},"__esModule",{value:!0}),o);var B={};z(B,{S3:()=>y,default:()=>b});module.exports=H(B);var E=require("node:crypto"),j={contents:!0},y=class{constructor({accessKeyId:t,secretAccessKey:r,endpoint:e,bucketName:s="",region:a="auto"}){if(typeof t!="string"||t.length===0)throw new TypeError("accessKeyId must be a non-empty string");if(typeof r!="string"||r.length===0)throw new TypeError("secretAccessKey must be a non-empty string");if(typeof e!="string"||e.length===0)throw new TypeError("endpoint must be a non-empty string");this.accessKeyId=t,this.secretAccessKey=r,this.endpoint=e,this.bucketName=s,this.region=a}getBucketName=()=>this.bucketName;getRegion=()=>this.region;getEndpoint=()=>this.endpoint;getProps=()=>({accessKeyId:this.accessKeyId,secretAccessKey:this.secretAccessKey,region:this.region,bucket:this.bucket});async sign(t,r,e,s,a){let i=new Date().toISOString().replace(/[:-]|\.\d{3}/g,""),n=new URL(r,this.endpoint),c=encodeURIComponent(this.bucketName);n.pathname=`/${c}${n.pathname}`;let d=Object.entries(s).map(([l,T])=>`${l.toLowerCase()}:${String(T).trim()}`).sort().join(`
`),g=Object.keys(s).map(l=>l.toLowerCase()).sort().join(";"),h=[t,encodeURI(n.pathname),L(e),d+`
`,g,a?await S(a):"UNSIGNED-PAYLOAD"].join(`
`),u=[i.slice(0,8),this.region,"s3","aws4_request"].join("/"),m=["AWS4-HMAC-SHA256",i,u,await S(h)].join(`
`),p=await N(this.secretAccessKey,i.slice(0,8),this.region,"s3"),f=await w(p,m,"hex"),x=["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+u,"SignedHeaders="+g,"Signature="+f].join(", ");return s.Authorization=x,s["x-amz-content-sha256"]=a?await S(a):"UNSIGNED-PAYLOAD",s["x-amz-date"]=i,s.host=n.host,{url:n.toString(),headers:s}}async list(t="/",r="",e=1e3,s="GET"){let a={"list-type":"2","max-keys":String(e)},i={"Content-Type":"application/json","x-amz-content-sha256":"UNSIGNED-PAYLOAD"},{url:n,headers:c}=await this.sign("GET",t,a,i,""),d=new URLSearchParams(a),g=`${n}?${d.toString()}`,h=await fetch(g,{headers:c});if(!h.ok){let f=await h.text();console.log("Error Body:",f);let x=h.headers.get("x-amz-error-code")||"Unknown",l=h.headers.get("x-amz-error-message")||h.statusText;throw new Error(`ListV2 failed with status ${h.status}: ${x} - ${l}`)}let u=[],m=await h.text();if(h.statusCode>299)throw u=s!=="HEAD"&&A(m).error||(t?"The specified key does not exist.":"The specified bucket is not valid."),new Error("yadada: "+errorMessage);u=s==="GET"?A(m):{size:+h.headers["content-length"],mtime:new Date(h.headers["last-modified"]),etag:h.headers.etag};let p=u.listBucketResult||u.error||u;return p.contents||p}async get(t,r){let e=r||{},s={"Content-Type":"application/json","x-amz-content-sha256":"UNSIGNED-PAYLOAD"},{url:a,headers:i}=await this.sign("GET",t,e,s,""),n=await fetch(a,{headers:i});if(!n.ok){let c=await n.text();console.error("Error Body:",c);let d=n.headers.get("x-amz-error-code")||"Unknown",g=n.headers.get("x-amz-error-message")||n.statusText;throw new Error(`GET failed with status ${n.status}: ${d} - ${g}`)}return n.text()}async put(t,r,e){let s=e||{},a={"Content-Length":r.length},{url:i,headers:n}=await this.sign("PUT",t,s,a,r),c=await fetch(i,{method:"PUT",headers:n,body:r});if(!c.ok){let d=await c.text();console.error("Error Body:",d);let g=c.headers.get("x-amz-error-code")||"Unknown",h=c.headers.get("x-amz-error-message")||c.statusText;throw new Error(`PUT failed with status ${c.status}: ${g} - ${h}`)}return c}async delete(t,r){let e=r||{},s={},{url:a,headers:i}=await this.sign("DELETE",t,e,s,""),n=await fetch(a,{method:"DELETE",headers:i});if(!n.ok){let c=await n.text();console.error("Error Body:",c);let d=n.headers.get("x-amz-error-code")||"Unknown",g=n.headers.get("x-amz-error-message")||n.statusText;throw new Error(`DELETE failed with status ${n.status}: ${d} - ${g}`)}return n.json()}},L=o=>{if(Object.keys(o).length<1)return"";let t=Object.keys(o).sort(),r="";for(let e=0;e<t.length;e++)r+=encodeURIComponent(t[e])+"="+encodeURIComponent(o[t[e]])+"&";return r.slice(0,-1)},N=async(o,t,r,e)=>{let s=await w(`AWS4${o}`,t),a=await w(s,r),i=await w(a,e);return await w(i,"aws4_request")},S=async o=>{let t=(0,E.createHash)("sha256");return t.update(o),t.digest("hex")},w=async(o,t,r)=>{let e=(0,E.createHmac)("sha256",o);return e.update(t),e.digest(r)},A=o=>{let t=i=>i.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),r,e,s={},a=/<(\w)([-\w]+)(?:\/|[^>]*>((?:(?!<\1)[\s\S])*)<\/\1\2)>/gm;for(;e=a.exec(o);)r=e[1].toLowerCase()+e[2],e=e[3]!=null?A(e[3]):!0,typeof e=="string"&&(e=t(e)),Array.isArray(s[r])?s[r].push(e):s[r]=s[r]!=null?[s[r],e]:j[r]?[e]:e;return r?s:o};var b=y;0&&(module.exports={S3});
//# sourceMappingURL=index.js.map
